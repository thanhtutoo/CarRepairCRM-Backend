# Node API Server

## Prerequisite
- Install nodemon `npm install -g nodemon`
- Install aws-cli

## Dynamodb 
1. aws configure
    AWS Access Key ID [None]: AKIAJP5DC6IXVYAQAQHQ
    AWS Secret Access Key [None]: 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
    Default region name [None]: us-east-1
    Default output format [None]: 
2. set value DYNAMO_TYPES_ENDPOINT in .env file to use local dynamodb.
3. run `aws dynamodb list-tables` or `aws dynamodb list-tables end-point=http://localhost:8000` 
    and confirm to use dynamodb.

## Commands
1. `npm start` - Starts the node server using nodemon and live compile using ts-node
2. `npm run build` - Builds the application and puts the generated javascript files into dist folder
3. `npm run db:crate` - Create And Initialize Database tables.
4. `npm run db:destroy` - Destroy all tables.

## Reference
https://basarat.gitbooks.io/typescript/docs/quick/nodejs.html

## Environment Configuration.
1. Set value of API_KEY and API_PWD in .env file.
   This is what the mobile app and admin web page use to take the data via api.
2. Set value DYNAMO_TYPES_ENDPOINT what is the url used to access dynamodb database.

## 
1. app_code     : Identify code of the garage generated by backend. ex:) pch1
2. reg_no       : Number of vehicle. ex:) UKPL8TE
3. vehicle_no   : Same as reg_no

## API List
###
- First line is request format every apis
- Second line is response format every apis
###
post /api/auth/login_dealer
    {user_name: '', password: ''}
    {status: '', user: {}}
post /api/auth/login_user
    {app_code: ''}
    {status: '', user: {}}

get /api/garages/:app_code/vehicles
    {#}
    {status: '', vehicles: []}
get /api/garages/:app_code/users
    {#}
    {status: '', users: []}
post /api/garages/find_by_service
    {app_code: '', services: '', book_date: ''}
    {status: '', grages: []}
post /api/services/self_service
    {reg_no: 'vehicle reg no', app_code: ''}
    {status: '', self_services: [{title: '', content: ''}]}
post /api/services/my_mechanic
    {reg_no: 'vehicle reg no', app_code: ''}
    {status: '', self_services: [{id: '', question: ''}]}
post /api/services/req_my_mechanic
    {reg_no: 'vehicle reg no', app_code: '', answers:[], email: ''}
    {status: ''}
post /api/services/book_mot_service
    {reg_no: 'vehicle reg no', app_code: '', date: 'book date', email: ''}
    {status: ''}
post /api/services/book_diagnose_quote
    {reg_no: 'vehicle reg no', app_code: '', date: 'book date', email: ''}
    {status: ''}
post /api/services/claim
    {reg_no: 'vehicle reg no', email: '', app_code: '', description: '', mileage: '', vehicle_diagnosed_before: 'true', claim_registered_before: 'false'}
    {status: ''}

get /api/vehicles/:reg_no/services;
    {}
    {status: '', service: }
get /api/vehicles/:reg_no/job;
    {}
    {status: '', job: {}}
get /api/users/:app_code/reminders;
    {}
    {status: '', reminders: []}
get /api/users/:app_code/notifications;
    {}
    {status: '', notifications: []}
get /api/users/:app_code/vehicles;
    {}
    {status: '', vehicles: []}
post /api/users/:app_code/add_vehicle;
    {reg_no: ''}
    {status: '', vehicle: {}}
post /api/users/:app_code/remove_vehicle;
    {reg_no: ''}
    {status: ''}

###
- Please see following classes for each response type.
###
export class Garage extends Table {
    public app_code: string;   // dealer's post code.
    public name: string;
    public services: string[];
    public vehicles: VehicleMeta[];
    public allow_self_service: boolean;         // allow customer to search other garages for self sevice.
    public allow_my_mechanic: boolean;          // allow customer to search other garages for my mechanic.
    public allow_book_mot_service: boolean;     // allow customer to search other garages for booking a mot or sevice.
    public allow_book_diagnose_quote: boolean;  // allow customer to search other garages for booking a diagnose or quote.

    // Geo location info
    public lon: number;
    public lat: number;
    public postal_code;
    public address;

    public created_at: string;
    public updated_at: string;
}


export class VehicleMeta {
    reg_no:             string;
    make:               string;
    taxed:              boolean;
    tax_due_at:         string;
    model:              string;
}

export class Vehicle {
    reg_no:             string;
    co2:                string;
    type_approval:      string;
    cylinder_capacity:  number;
    fuel:               string;
    registered_year:    string;
    registered_at:      string;
    make:               string;
    export_marker:      string;
    taxed:              boolean;
    tax_due_at:         string;
    is_sorn:            boolean;
    colour:             string;
    wheel_plan:         string;
    no_mot_data_held_by_dvla: boolean;
    no_mot_results_returned_by_dvla: boolean;
    raw_dvla_mot_status:    string;
    mot_exempt:         boolean;
    motd:               boolean;
    mot_expiry_at:      string;
    dvla_results:       boolean;
    dvsa_result:        boolean;
    dvla_dvsa_compatible: boolean;
    model:              string;
    mot_qty_recorded_in_miles:  number;
    mot_qty_recorded_in_kms:    number;
    mot_miles_and_kms:          boolean;
    mot_pass_qty:               number;
    mot_fail_qt:                number;
    mot_total_advisory_notices: number;
    mot_total_failure_notices:  number;
    make_dvsa:                  string;
    model_dvsa:                 string;
    first_used_dvsa_at:         string;
    mot_expiry_dvsa_at:         string;
    fuel_dvsa:                  string;
    colour_dvsa:                string;
    motd_dvsa:                  boolean;
    date_of_registration_source:    string;

    mots: Mot[];
}


export class Job extends Table {
    public id: number;
    public vehicle_reg: string;
    public type: string;
    public state: string;       // refer JobState
    public state_notes: string[];
    public services: string[];
    public submitted_at: string;
    public quote_approved_at: string;
    public quote_accepted_at: string;
    public paid_at: string;
    public completed_at: string;
    public created_at: string;
    public updated_at: string;
}


export class Reminder extends Table {
    public id: number;
    public app_code: string;   // user's
    public name: string;
    public enabled: boolean;    // Enable/Disable this reminder.
    public tregger_at: string;
    public created_at: string;
    public updated_at: string;
}

export class Notify extends Table {
    public id: number;
    public to_email: string;
    public to_app_code: string;
    public message: string;
    public readen: boolean;
    public readen_at: string;
    public created_at: string;
    public updated_at: string;
}
